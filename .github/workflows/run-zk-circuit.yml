name: Run ZK Circuit Proof Generation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Install dependencies
      - name: Install Node.js and SnarkJS
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install SnarkJS globally
        run: npm install -g snarkjs

      # Install Circom
      - name: Install Circom
        run: |
          sudo apt update
          sudo apt install -y cargo
          git clone https://github.com/iden3/circom.git
          cd circom
          cargo build --release
          sudo ln -s $(pwd)/target/release/circom /usr/local/bin/circom

      # Compile the circuit
      - name: Compile Circuit
        run: circom Equation.circom --r1cs --wasm --sym

      # Set up trusted setup (download pre-existing ptau file)
      - name: ZKProof Workflow
        
        on: [push]
        
        jobs:
          trusted_setup:
            runs-on: ubuntu-latest
            steps:
              - name: Checkout code
                uses: actions/checkout@v2
        
              - name: Install snarkjs
                run: npm install -g snarkjs
        
              - name: Create new Powers of Tau File
                run: |
                  snarkjs powersoftau new bn128 14 pot14_0000.ptau -v
        
              - name: Contribute to Powers of Tau File
                run: |
                  snarkjs powersoftau contribute pot14_0000.ptau pot14_0001.ptau --name="First contribution" -v
        
              - name: Perform Trusted Setup
                run: |
                  snarkjs groth16 setup Equation.r1cs pot14_0001.ptau Equation_0000.zkey
                  snarkjs zkey contribute Equation_0000.zkey Equation_final.zkey --name="Second contribution" -v
        


      # Export verification key
      - name: Export Verification Key
        run: snarkjs zkey export verificationkey Equation_final.zkey verification_key.json

      # Generate the witness
      - name: Generate Witness
        run: |
          node Equation_js/generate_witness.js Equation_js/Equation.wasm input.json witness.wtns

      # Generate the proof
      - name: Generate Proof
        run: snarkjs groth16 prove Equation_final.zkey witness.wtns proof.json public.json

      # Verify the proof
      - name: Verify Proof
        run: snarkjs groth16 verify verification_key.json public.json proof.json
